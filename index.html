<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RobloxCharts</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:      #07080f;
      --surface: #0c0e18;
      --border:  #181d2e;
      --accent:  #4f8ef7;
      --accent2: #38e8c6;
      --text:    #edf0ff;
      --muted:   #424966;
      --green:   #3de07a;
      --card-bg: #090b14;
    }

    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* grid lines bg */
    body::after {
      content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:
        linear-gradient(rgba(79,142,247,0.028) 1px, transparent 1px),
        linear-gradient(90deg, rgba(79,142,247,0.028) 1px, transparent 1px);
      background-size: 56px 56px;
    }

    /* top glow blob */
    .glow {
      position:fixed; top:-25vh; left:50%; transform:translateX(-50%);
      width:1000px; height:600px; z-index:0; pointer-events:none;
      background: radial-gradient(ellipse, rgba(79,142,247,0.09) 0%, transparent 65%);
    }

    /* ── HEADER ── */
    header {
      position:sticky; top:0; z-index:200;
      background: rgba(7,8,15,0.82);
      backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      height:62px; padding:0 48px;
      display:flex; align-items:center; justify-content:space-between;
    }

    .logo {
      font-family:'Bebas Neue', sans-serif;
      font-size:1.55rem; letter-spacing:3px;
      color:var(--text);
    }
    .logo em { color:var(--accent); font-style:normal; }

    .header-center {
      flex:1; max-width:420px; margin:0 40px;
      position:relative;
    }

    .search-wrap {
      position:relative; display:flex; align-items:center;
    }

    .search-icon {
      position:absolute; left:12px; color:var(--muted);
      font-size:0.9rem; pointer-events:none; line-height:1;
    }

    #searchInput {
      width:100%; background:var(--surface);
      border:1px solid var(--border);
      border-radius:6px; padding:8px 12px 8px 36px;
      color:var(--text); font-family:'Barlow',sans-serif;
      font-size:0.85rem; font-weight:500;
      outline:none; transition: border-color 0.15s, box-shadow 0.15s;
    }
    #searchInput::placeholder { color:var(--muted); }
    #searchInput:focus {
      border-color:rgba(79,142,247,0.5);
      box-shadow: 0 0 0 3px rgba(79,142,247,0.08);
    }

    .search-clear {
      position:absolute; right:10px;
      background:none; border:none; color:var(--muted);
      cursor:pointer; font-size:0.9rem; padding:2px 4px;
      display:none; line-height:1;
      transition: color 0.15s;
    }
    .search-clear:hover { color:var(--text); }
    .search-clear.visible { display:block; }

    .header-right { display:flex; align-items:center; gap:10px; }

    .live-badge {
      display:flex; align-items:center; gap:6px;
      font-family:'JetBrains Mono', monospace;
      font-size:0.6rem; letter-spacing:1.5px; text-transform:uppercase;
      color:var(--green);
      background:rgba(61,224,122,0.07);
      border:1px solid rgba(61,224,122,0.18);
      padding:5px 12px; border-radius:4px;
    }
    .live-dot {
      width:5px; height:5px; border-radius:50%;
      background:var(--green);
      animation: blink 1.8s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

    .refresh-btn {
      background:transparent;
      border:1px solid var(--border); color:var(--muted);
      font-family:'JetBrains Mono',monospace;
      font-size:0.68rem; padding:6px 14px; border-radius:4px;
      cursor:pointer; transition:all 0.15s;
    }
    .refresh-btn:hover { border-color:var(--accent); color:var(--accent); }

    /* ── HERO ── */
    .hero {
      position:relative; z-index:1;
      padding:72px 48px 36px;
      max-width:1500px; margin:0 auto;
    }

    .hero-eyebrow {
      font-family:'JetBrains Mono',monospace;
      font-size:0.65rem; color:var(--accent);
      letter-spacing:3px; text-transform:uppercase;
      margin-bottom:14px;
      opacity:0; animation:up 0.5s ease 0.05s both;
    }

    .hero h1 {
      font-family:'Bebas Neue',sans-serif;
      font-size: clamp(3.8rem, 8.5vw, 7.5rem);
      line-height:0.9; letter-spacing:3px;
      margin-bottom:22px;
      opacity:0; animation:up 0.5s ease 0.1s both;
    }

    .hero h1 .dim { color:rgba(237,240,255,0.22); }
    .hero h1 .bright { color:var(--accent); }

    .hero-sub {
      color:var(--muted); font-size:0.92rem; font-weight:500;
      max-width:420px; line-height:1.75;
      opacity:0; animation:up 0.5s ease 0.15s both;
    }

    @keyframes up {
      from { opacity:0; transform:translateY(14px); }
      to   { opacity:1; transform:translateY(0); }
    }

    /* ── STATS ROW ── */
    .stats-bar {
      position:relative; z-index:1;
      max-width:1500px; margin:0 auto;
      padding:0 48px 30px;
      display:flex; gap:2px;
      opacity:0; animation:up 0.5s ease 0.2s both;
    }

    .stat-pill {
      background:var(--surface); border:1px solid var(--border);
      padding:11px 22px;
    }
    .stat-pill:first-child { border-radius:6px 0 0 6px; }
    .stat-pill:last-child  { border-radius:0 6px 6px 0; }
    .stat-pill-label {
      font-family:'JetBrains Mono',monospace;
      font-size:0.55rem; color:var(--muted);
      letter-spacing:1.5px; text-transform:uppercase; margin-bottom:2px;
    }
    .stat-pill-val {
      font-family:'Barlow Condensed',sans-serif;
      font-size:1.25rem; font-weight:700; color:var(--text); letter-spacing:1px;
    }

    /* ── TOOLBAR ── */
    .toolbar {
      position:relative; z-index:1;
      max-width:1500px; margin:0 auto;
      padding:0 48px 24px;
      display:flex; align-items:center; gap:6px; flex-wrap:wrap;
      opacity:0; animation:up 0.5s ease 0.25s both;
    }

    .toolbar-label {
      font-family:'JetBrains Mono',monospace;
      color:var(--muted); font-size:0.6rem;
      letter-spacing:1.5px; text-transform:uppercase; margin-right:6px;
    }

    .sort-btn {
      background:var(--surface); border:1px solid var(--border);
      color:var(--muted); font-family:'Barlow',sans-serif;
      font-size:0.78rem; font-weight:600; letter-spacing:0.3px;
      padding:7px 18px; border-radius:4px;
      cursor:pointer; transition:all 0.15s;
    }
    .sort-btn:hover { border-color:rgba(79,142,247,0.45); color:var(--text); }
    .sort-btn.active {
      background:rgba(79,142,247,0.15);
      border-color:var(--accent); color:var(--accent);
    }

    /* search result count badge */
    .search-count {
      margin-left:auto;
      font-family:'JetBrains Mono',monospace;
      font-size:0.62rem; color:var(--muted); letter-spacing:1px;
    }

    /* ── GRID ── */
    .grid-wrap {
      position:relative; z-index:1;
      max-width:1500px; margin:0 auto;
      padding:0 48px 80px;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap:1px;
      background:var(--border);
      border:1px solid var(--border);
      border-radius:8px;
      overflow:hidden;
    }

    /* ── CARD ── */
    .card {
      background:var(--card-bg);
      cursor:pointer; position:relative;
      transition: background 0.15s;
      contain: layout style;
    }
    .card:hover { background:#0f1220; }

    /* glowing top border on hover */
    .card::before {
      content:''; position:absolute; top:0; left:0; right:0;
      height:2px; z-index:3;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity:0; transition: opacity 0.2s;
    }
    .card:hover::before { opacity:1; }

    /* rank badge */
    .card-rank {
      position:absolute; top:8px; left:8px; z-index:2;
      font-family:'Bebas Neue',sans-serif;
      font-size:1rem; letter-spacing:1px;
      padding:2px 8px; border-radius:3px;
      background:rgba(7,8,15,0.75);
      backdrop-filter:blur(6px);
      border:1px solid rgba(255,255,255,0.12);
      color:var(--text);
      line-height:1.4;
    }


    .card-thumb-wrap { position:relative; overflow:hidden; background:var(--surface); }
    .card-thumb {
      width:100%; aspect-ratio:1/1; object-fit:cover; display:block;
      transition:transform 0.35s ease;
    }
    .card:hover .card-thumb { transform:scale(1.06); }
    .card-thumb-placeholder {
      width:100%; aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      font-family:'JetBrains Mono',monospace;
      font-size:0.55rem; color:var(--muted); letter-spacing:2px;
    }

    .card-body { padding:12px 14px 14px; }

    .card-name {
      font-family:'Barlow Condensed',sans-serif;
      font-size:1rem; font-weight:700; letter-spacing:0.3px;
      line-height:1.25; margin-bottom:10px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .card-stats { display:grid; grid-template-columns:1fr 1fr; gap:5px; }

    .stat {
      background:rgba(255,255,255,0.025);
      border:1px solid rgba(255,255,255,0.045);
      border-radius:3px; padding:7px 9px;
    }
    .stat-label {
      font-family:'JetBrains Mono',monospace;
      font-size:0.5rem; color:var(--muted);
      letter-spacing:1px; text-transform:uppercase; margin-bottom:1px;
    }
    .stat-val {
      font-family:'Barlow Condensed',sans-serif;
      font-size:0.92rem; font-weight:700; letter-spacing:0.3px;
    }
    .stat-val.green  { color:var(--green); }
    .stat-val.blue   { color:#6aaeff; }
    .stat-val.white  { color:var(--text); }
    .stat-val.teal   { color:var(--accent2); }
    .stat-val.muted  { color:var(--muted); font-style:italic; font-size:0.75rem; }

    /* ── SKELETON ── */
    .skeleton { background:var(--card-bg); }
    .skel-thumb { width:100%; aspect-ratio:1/1; background:var(--surface); }
    .skel-body  { padding:12px 14px 14px; }
    .skel-line  {
      height:7px; border-radius:2px; margin-bottom:7px;
      background:linear-gradient(90deg, var(--border) 25%, #1e2640 50%, var(--border) 75%);
      background-size:200% 100%;
      animation:shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* no results */
    .no-results {
      grid-column:1/-1; text-align:center; padding:80px 20px; color:var(--muted);
    }
    .no-results h3 {
      font-family:'Bebas Neue',sans-serif; font-size:1.8rem;
      letter-spacing:2px; color:var(--text); margin-bottom:8px;
    }

    /* error */
    .error-box { grid-column:1/-1; text-align:center; padding:80px 20px; color:var(--muted); }
    .error-box h2 { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:2px; color:var(--text); margin-bottom:8px; }
    .error-box pre { margin:12px auto 0; font-family:'JetBrains Mono',monospace; font-size:0.7rem; background:var(--surface); border:1px solid var(--border); padding:12px; border-radius:4px; max-width:500px; overflow-x:auto; white-space:pre-wrap; }

    footer {
      position:relative; z-index:1;
      border-top:1px solid var(--border);
      padding:18px 48px; text-align:center;
      color:var(--muted); font-family:'JetBrains Mono',monospace;
      font-size:0.6rem; letter-spacing:1px;
    }

    ::-webkit-scrollbar { width:5px; }
    ::-webkit-scrollbar-track { background:var(--bg); }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

    @media(max-width:640px) {
      header { padding:0 16px; flex-wrap:wrap; height:auto; gap:10px; padding-top:10px; padding-bottom:10px; }
      .header-center { max-width:100%; margin:0; order:3; width:100%; }
      .hero, .stats-bar, .toolbar, .grid-wrap { padding-left:16px; padding-right:16px; }
      .hero h1 { font-size:3.2rem; }
      .grid { grid-template-columns:repeat(2,1fr); }
    }
  </style>
</head>
<body>

<div class="glow"></div>

<header>
  <div class="logo">Roblox<em>Charts</em></div>

  <div class="header-center">
    <div class="search-wrap">
      <span class="search-icon">⌕</span>
      <input type="text" id="searchInput" placeholder="Search games…" autocomplete="off" spellcheck="false"/>
      <button class="search-clear" id="searchClear" title="Clear search">✕</button>
    </div>
  </div>

  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div>Live</div>
    <button class="refresh-btn" id="refreshBtn">↻ Refresh</button>
  </div>
</header>

<section class="hero">
  <div class="hero-eyebrow">Real-time leaderboard</div>
  <h1>
    TOP ROBLOX<br>
    GAMES <span class="bright">RIGHT NOW</span>
  </h1>
  <p class="hero-sub">Live player counts, total visits, and favorites — pulled from Rolimons &amp; Roblox.</p>
</section>

<div class="stats-bar">
  <div class="stat-pill">
    <div class="stat-pill-label">Total Playing</div>
    <div class="stat-pill-val" id="totalPlaying">—</div>
  </div>
  <div class="stat-pill">
    <div class="stat-pill-label">Games Tracked</div>
    <div class="stat-pill-val" id="gamesTracked">—</div>
  </div>
  <div class="stat-pill">
    <div class="stat-pill-label">Last Updated</div>
    <div class="stat-pill-val" id="lastUpdated">—</div>
  </div>
</div>

<div class="toolbar">
  <span class="toolbar-label">Sort by</span>
  <button class="sort-btn active" data-sort="TopCharts">Top Charts</button>
  <button class="sort-btn" data-sort="MostEngaging">Most Engaging</button>
  <button class="sort-btn" data-sort="UpAndComing">Up &amp; Coming</button>
  <span class="search-count" id="searchCount"></span>
</div>

<div class="grid-wrap">
  <div class="grid" id="gameGrid"></div>
</div>

<footer>RobloxCharts — not affiliated with Roblox Corporation · Data via Rolimons &amp; Roblox public API</footer>

<script>
  const WORKER_URL = 'https://young-resonance-128e.frostyknight2354.workers.dev';
  let currentSort = 'TopCharts';
  let loading = false;
  let allGames = [];
  // Map of placeId → {visits, upVotes, favoritedCount} — filled in progressively
  let detailCache = {};

  // ── FORMAT ─────────────────────────────────────────────
  function fmt(n) {
    if (n == null) return null;
    if (n >= 1e9) return (n/1e9).toFixed(1)+'B';
    if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
    if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
    return n.toLocaleString();
  }
  function fmtStat(n) { const v = fmt(n); return v !== null ? v : '—'; }

  function animateCount(el, target) {
    if (!target) { el.textContent = fmtStat(target); return; }
    const duration = 650, t0 = performance.now();
    function step(now) {
      const p = Math.min((now - t0) / duration, 1);
      const e = 1 - Math.pow(1-p, 3);
      el.textContent = fmtStat(Math.round(e * target));
      if (p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // ── FETCH ──────────────────────────────────────────────
  async function workerFetch(params) {
    const res = await fetch(WORKER_URL + '?' + new URLSearchParams(params));
    if (!res.ok) throw new Error(`Worker returned ${res.status}`);
    return res.json();
  }

  // ── SKELETONS ──────────────────────────────────────────
  function showSkeletons() {
    const frag = document.createDocumentFragment();
    for (let i = 0; i < 32; i++) {
      const el = document.createElement('div');
      el.className = 'skeleton';
      el.innerHTML = `<div class="skel-thumb"></div><div class="skel-body">
        <div class="skel-line" style="width:60%"></div>
        <div class="skel-line" style="width:40%"></div>
        <div class="skel-line" style="width:50%"></div></div>`;
      frag.appendChild(el);
    }
    const grid = document.getElementById('gameGrid');
    grid.innerHTML = '';
    grid.appendChild(frag);
  }

  // ── RENDER CARDS ───────────────────────────────────────
  function renderCards(games) {
    const grid = document.getElementById('gameGrid');
    const searchCount = document.getElementById('searchCount');

    if (!games.length) {
      grid.innerHTML = `<div class="no-results"><h3>No Results</h3><p>Try a different search term.</p></div>`;
      searchCount.textContent = '';
      return;
    }

    const q = document.getElementById('searchInput').value.trim();
    searchCount.textContent = q ? `${games.length} result${games.length !== 1 ? 's' : ''}` : '';

    const total = games.reduce((s,g) => s + (g.playerCount||0), 0);
    animateCount(document.getElementById('totalPlaying'), total);
    document.getElementById('gamesTracked').textContent = allGames.length.toLocaleString();
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

    const frag = document.createDocumentFragment();
    games.forEach((g, i) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.placeid = g.rootPlaceId;

      const rankClass = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
      const safeName = (g.name||'Unknown').replace(/[<>]/g, c => c==='<'?'&lt;':'&gt;');

      // Merge detail cache if available
      const detail = detailCache[g.rootPlaceId] || {};
      const visits = fmtStat(detail.visits ?? null);
      const likes  = fmtStat(detail.upVotes ?? null);
      const favs   = fmtStat(detail.favoritedCount ?? null);

      card.innerHTML = `
        <div class="card-thumb-wrap">
          ${g.iconUrl
            ? `<img class="card-thumb" src="${g.iconUrl}" alt="${safeName}" loading="lazy" decoding="async"/>`
            : `<div class="card-thumb-placeholder">NO IMG</div>`}
          <div class="card-rank ${rankClass}">#${i+1}</div>
        </div>
        <div class="card-body">
          <div class="card-name">${safeName}</div>
          <div class="card-stats">
            <div class="stat"><div class="stat-label">Playing</div><div class="stat-val green">${fmtStat(g.playerCount)}</div></div>
            <div class="stat"><div class="stat-label">Visits</div><div class="stat-val blue" data-field="visits">${visits}</div></div>
            <div class="stat"><div class="stat-label">Likes</div><div class="stat-val white" data-field="upVotes">${likes}</div></div>
            <div class="stat"><div class="stat-label">Favorites</div><div class="stat-val teal" data-field="favoritedCount">${favs}</div></div>
          </div>
        </div>`;

      if (g.rootPlaceId) {
        card.addEventListener('click', () => window.open(`https://www.roblox.com/games/${g.rootPlaceId}`, '_blank'));
      }
      frag.appendChild(card);
    });

    grid.innerHTML = '';
    grid.appendChild(frag);
  }

  // ── UPDATE CARD DETAILS IN-PLACE ───────────────────────
  // Called as each detail batch comes back — updates DOM without re-rendering
  function patchCardDetails(details) {
    Object.entries(details).forEach(([placeId, d]) => {
      if (!d) return;
      detailCache[placeId] = d;
      const card = document.querySelector(`.card[data-placeid="${placeId}"]`);
      if (!card) return;
      const set = (field, val) => {
        const el = card.querySelector(`[data-field="${field}"]`);
        if (el) el.textContent = fmtStat(val);
      };
      set('visits',         d.visits);
      set('upVotes',        d.upVotes);
      set('favoritedCount', d.favoritedCount);
    });
  }

  // ── FETCH DETAILS IN BACKGROUND ────────────────────────
  // Sends games in pages of 100 placeIds so each worker call stays fast
  async function fetchDetailsProgressively(games) {
    const PAGE = 100;
    const placeIds = games.map(g => g.rootPlaceId).filter(Boolean);

    for (let i = 0; i < placeIds.length; i += PAGE) {
      const batch = placeIds.slice(i, i + PAGE);
      try {
        const data = await workerFetch({ action: 'get-details', placeIds: batch.join(',') });
        if (data.details) patchCardDetails(data.details);
      } catch(err) {
        console.warn('Detail batch failed:', err.message);
      }
    }
  }

  // ── SEARCH ─────────────────────────────────────────────
  function applySearch() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    document.getElementById('searchClear').classList.toggle('visible', q.length > 0);
    if (!allGames.length) return;
    renderCards(q ? allGames.filter(g => (g.name||'').toLowerCase().includes(q)) : allGames);
  }

  // ── LOAD ───────────────────────────────────────────────
  async function load(sortName) {
    if (loading) return;
    loading = true;
    detailCache = {}; // clear cache on new load

    showSkeletons();

    try {
      // Step 1: fast — get game list (just names + player counts + icons)
      const data = await workerFetch({ action: 'get-sort-content', sortId: sortName });
      allGames = data.games || [];
      if (!allGames.length) throw new Error('No games returned');

      document.getElementById('searchInput').value = '';
      document.getElementById('searchClear').classList.remove('visible');
      document.getElementById('searchCount').textContent = '';

      renderCards(allGames);

      // Step 2: slow — fetch visits/likes/favorites in background pages
      // Don't await — runs independently, patches cards as data arrives
      fetchDetailsProgressively(allGames);

    } catch(err) {
      console.error(err);
      document.getElementById('gameGrid').innerHTML = `
        <div class="error-box">
          <h2>Couldn't Load Games</h2>
          <p>Something went wrong fetching data.</p>
          <pre>${err.message}</pre>
        </div>`;
    } finally {
      loading = false;
    }
  }

  // ── EVENTS ─────────────────────────────────────────────
  document.querySelectorAll('.sort-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.classList.contains('active') || loading) return;
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentSort = btn.dataset.sort;
      load(currentSort);
    });
  });

  document.getElementById('refreshBtn').addEventListener('click', () => {
    if (!loading) load(currentSort);
  });

  let searchTimer;
  document.getElementById('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(applySearch, 120);
  });

  document.getElementById('searchClear').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchClear').classList.remove('visible');
    renderCards(allGames);
    document.getElementById('searchInput').focus();
  });

  // ── INIT ───────────────────────────────────────────────
  load(currentSort);
</script>
</body>
</html>