<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RobloxCharts</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:      #07080f;
      --surface: #0c0e18;
      --border:  #181d2e;
      --accent:  #3a7ff7;
      --accent2: #38e8c6;
      --text:    #edf0ff;
      --muted:   #6d748d;
      --green:   #3de07a;
      --card-bg: #090b14;
    }

    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::after {
      content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:
        linear-gradient(rgba(79,142,247,0.028) 1px, transparent 1px),
        linear-gradient(90deg, rgba(79,142,247,0.028) 1px, transparent 1px);
      background-size: 56px 56px;
    }

    .glow {
      position:fixed; top:-25vh; left:50%; transform:translateX(-50%);
      width:1000px; height:600px; z-index:0; pointer-events:none;
      background: radial-gradient(ellipse, rgba(79,142,247,0.09) 0%, transparent 65%);
    }

    header {
      position:sticky; top:0; z-index:200;
      background: rgba(7,8,15,0.82);
      backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      height:72px; padding:0 48px;
      display:flex; align-items:center; justify-content:space-between;
    }

    .logo { font-family:'Bebas Neue',sans-serif; font-size:1.9rem; letter-spacing:3px; color:var(--text); }
    .logo em { color:var(--accent); font-style:normal; }

    .header-center { flex:1; max-width:560px; margin:0 40px; }
    .search-wrap   { position:relative; display:flex; align-items:center; gap:8px; }
    .search-input-wrap { position:relative; flex:1; }
    .search-icon { position:absolute; left:13px; color:var(--muted); font-size:1rem; pointer-events:none; line-height:1; top:50%; transform:translateY(-50%); }

    #searchInput {
      width:100%; background:var(--surface);
      border:1px solid var(--border); border-radius:7px;
      padding:10px 36px 10px 40px;
      color:var(--text); font-family:'Barlow',sans-serif;
      font-size:0.95rem; font-weight:500;
      outline:none; transition: border-color 0.15s, box-shadow 0.15s;
    }
    #searchInput::placeholder { color:var(--muted); }
    #searchInput:focus { border-color:rgba(79,142,247,0.5); box-shadow: 0 0 0 3px rgba(79,142,247,0.08); }

    .search-clear {
      position:absolute; right:11px; top:50%; transform:translateY(-50%);
      background:none; border:none; color:var(--muted);
      cursor:pointer; font-size:1rem; padding:2px 4px; display:none; line-height:1; transition:color 0.15s;
    }
    .search-clear:hover { color:var(--text); }
    .search-clear.visible { display:block; }

    #lookupBtn {
      flex-shrink:0;
      background:rgba(79,142,247,0.12); border:1px solid rgba(79,142,247,0.35); color:var(--accent);
      font-family:'JetBrains Mono',monospace; font-size:0.72rem; font-weight:500;
      letter-spacing:0.5px; padding:10px 16px; border-radius:7px;
      cursor:pointer; transition:all 0.15s; white-space:nowrap;
    }
    #lookupBtn:hover { background:rgba(79,142,247,0.22); border-color:var(--accent); }

    .header-right { display:flex; align-items:center; gap:10px; }

    .live-badge {
      display:flex; align-items:center; gap:7px;
      font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:1.5px; text-transform:uppercase;
      color:var(--green); background:rgba(61,224,122,0.07); border:1px solid rgba(61,224,122,0.18);
      padding:7px 14px; border-radius:4px;
    }
    .live-dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:blink 1.8s ease-in-out infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

    .refresh-btn {
      background:transparent; border:1px solid var(--border); color:var(--muted);
      font-family:'JetBrains Mono',monospace; font-size:0.75rem; padding:7px 16px; border-radius:4px;
      cursor:pointer; transition:all 0.15s;
    }
    .refresh-btn:hover { border-color:var(--accent); color:var(--accent); }
    .refresh-btn:disabled { opacity:0.4; cursor:not-allowed; }

    /* â”€â”€ LOOKUP MODAL â”€â”€ */
    .modal-overlay {
      position:fixed; inset:0; z-index:500;
      background:rgba(0,0,0,0.7); backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s;
    }
    .modal-overlay.open { opacity:1; pointer-events:all; }

    .modal {
      background:var(--surface); border:1px solid var(--border);
      border-radius:10px; padding:32px; width:100%; max-width:460px;
      transform:translateY(12px); transition:transform 0.2s;
      position:relative;
    }
    .modal-overlay.open .modal { transform:translateY(0); }

    .modal-title { font-family:'Bebas Neue',sans-serif; font-size:1.9rem; letter-spacing:2px; color:var(--text); margin-bottom:6px; }
    .modal-sub { font-family:'JetBrains Mono',monospace; font-size:0.72rem; color:var(--muted); letter-spacing:1px; margin-bottom:22px; line-height:1.6; }
    .modal-input-row { display:flex; gap:8px; margin-bottom:16px; }

    #placeIdInput {
      flex:1; background:var(--bg); border:1px solid var(--border); border-radius:6px;
      padding:12px 16px; color:var(--text); font-family:'JetBrains Mono',monospace;
      font-size:0.95rem; outline:none; transition:border-color 0.15s, box-shadow 0.15s;
    }
    #placeIdInput::placeholder { color:var(--muted); }
    #placeIdInput:focus { border-color:rgba(79,142,247,0.5); box-shadow:0 0 0 3px rgba(79,142,247,0.08); }

    #placeIdSubmit {
      background:var(--accent); border:none; color:#fff;
      font-family:'Barlow',sans-serif; font-size:0.95rem; font-weight:700;
      padding:12px 22px; border-radius:6px; cursor:pointer; transition:opacity 0.15s; white-space:nowrap;
    }
    #placeIdSubmit:hover { opacity:0.85; }
    #placeIdSubmit:disabled { opacity:0.4; cursor:not-allowed; }

    .modal-hint { font-family:'JetBrains Mono',monospace; font-size:0.68rem; color:var(--muted); letter-spacing:0.5px; margin-bottom:20px; line-height:1.7; }
    .modal-hint code { color:var(--accent2); background:rgba(56,232,198,0.08); padding:1px 5px; border-radius:3px; }

    .lookup-result { background:var(--bg); border:1px solid var(--border); border-radius:8px; overflow:hidden; display:none; }
    .lookup-result.visible { display:block; }
    .lookup-result-inner { display:flex; gap:0; align-items:stretch; }
    .lookup-thumb { width:100px; height:100px; object-fit:cover; flex-shrink:0; display:block; }
    .lookup-thumb-placeholder { width:100px; height:100px; background:var(--surface); display:flex; align-items:center; justify-content:center; font-family:'JetBrains Mono',monospace; font-size:0.5rem; color:var(--muted); }
    .lookup-info { padding:14px 16px; flex:1; min-width:0; }
    .lookup-name { font-family:'Barlow Condensed',sans-serif; font-size:1.05rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:8px; }
    .lookup-stats { display:flex; gap:12px; flex-wrap:wrap; }
    .lookup-stat { font-family:'JetBrains Mono',monospace; font-size:0.6rem; color:var(--muted); }
    .lookup-stat span { color:var(--text); font-weight:600; display:block; font-size:0.82rem; font-family:'Barlow Condensed',sans-serif; }
    .lookup-open-btn { display:block; width:100%; background:rgba(79,142,247,0.1); border:none; border-top:1px solid var(--border); color:var(--accent); font-family:'Barlow',sans-serif; font-size:0.8rem; font-weight:600; padding:10px; cursor:pointer; transition:background 0.15s; }
    .lookup-open-btn:hover { background:rgba(79,142,247,0.2); }

    .lookup-error { font-family:'JetBrains Mono',monospace; font-size:0.68rem; color:#ff6b6b; background:rgba(255,107,107,0.08); border:1px solid rgba(255,107,107,0.2); border-radius:5px; padding:10px 14px; display:none; }
    .lookup-error.visible { display:block; }
    .lookup-loading { font-family:'JetBrains Mono',monospace; font-size:0.68rem; color:var(--muted); text-align:center; padding:16px; display:none; }
    .lookup-loading.visible { display:block; }

    .modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--muted); font-size:1.1rem; cursor:pointer; transition:color 0.15s; line-height:1; padding:4px; }
    .modal-close:hover { color:var(--text); }

    /* â”€â”€ DETAIL PANEL â”€â”€ */
    .detail-backdrop {
      position:fixed; inset:0; z-index:300;
      background:rgba(0,0,0,0.55); backdrop-filter:blur(4px);
      opacity:0; pointer-events:none;
      transition:opacity 0.25s ease;
    }
    .detail-backdrop.open { opacity:1; pointer-events:all; }

    .detail-panel {
      position:fixed; top:0; right:0; bottom:0; z-index:301;
      width:min(780px, 100vw);
      background:var(--surface);
      border-left:1px solid var(--border);
      display:flex; flex-direction:column;
      transform:translateX(100%);
      transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
      overflow:hidden;
    }
    .detail-panel.open { transform:translateX(0); }

    .detail-header {
      position:relative;
      flex-shrink:0;
      height:260px;
      overflow:hidden;
    }
    .detail-banner {
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter:brightness(0.45) saturate(1.2);
    }
    .detail-banner-placeholder {
      width:100%; height:100%;
      background:linear-gradient(135deg, #0c0e18 0%, #111627 100%);
    }
    .detail-header-overlay {
      position:absolute; inset:0;
      background:linear-gradient(to bottom, transparent 20%, var(--surface) 100%);
    }
    .detail-close {
      position:absolute; top:14px; right:14px;
      background:rgba(7,8,15,0.7); border:1px solid var(--border);
      color:var(--muted); font-size:1rem; cursor:pointer;
      width:32px; height:32px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      transition:all 0.15s; backdrop-filter:blur(8px);
    }
    .detail-close:hover { color:var(--text); border-color:rgba(255,255,255,0.25); }

    .detail-identity {
      position:absolute; bottom:14px; left:0; right:0;
      padding:0 22px;
      display:flex; align-items:flex-end; gap:14px;
    }
    .detail-thumb-sm {
      width:88px; height:88px; border-radius:8px;
      object-fit:cover; border:2px solid var(--border);
      flex-shrink:0;
    }
    .detail-thumb-sm-placeholder {
      width:88px; height:88px; border-radius:8px;
      background:var(--card-bg); border:2px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      font-family:'JetBrains Mono',monospace; font-size:0.5rem; color:var(--muted);
      flex-shrink:0;
    }
    .detail-title-block { min-width:0; }
    .detail-game-name {
      font-family:'Barlow Condensed',sans-serif; font-size:1.85rem;
      font-weight:800; line-height:1.1; letter-spacing:0.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin-bottom:6px;
    }
    .detail-creator {
      font-family:'JetBrains Mono',monospace; font-size:0.75rem;
      color:var(--muted); letter-spacing:0.5px;
    }
    .detail-creator a {
      color:var(--accent); text-decoration:none;
    }
    .detail-creator a:hover { text-decoration:underline; }

    .detail-body {
      flex:1; overflow-y:auto; padding:20px 26px 36px;
    }
    .detail-body::-webkit-scrollbar { width:4px; }
    .detail-body::-webkit-scrollbar-track { background:transparent; }
    .detail-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

    .detail-meta-row {
      display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; align-items:center;
    }
    .detail-badge {
      font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:1px;
      padding:5px 12px; border-radius:3px; text-transform:uppercase;
    }
    .detail-badge.genre  { color:var(--accent2); background:rgba(56,232,198,0.08); border:1px solid rgba(56,232,198,0.2); }
    .detail-badge.roblox { color:var(--muted);   background:var(--card-bg);         border:1px solid var(--border); cursor:pointer; transition:all 0.15s; }
    .detail-badge.roblox:hover { color:var(--text); border-color:rgba(255,255,255,0.25); }

    .detail-description {
      font-size:0.92rem; color:var(--muted); line-height:1.75;
      margin-bottom:24px;
      display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden;
    }
    .detail-description.expanded { -webkit-line-clamp:unset; }
    .desc-toggle {
      background:none; border:none; color:var(--accent);
      font-family:'JetBrains Mono',monospace; font-size:0.68rem; cursor:pointer;
      margin-top:-16px; margin-bottom:20px; display:block; transition:opacity 0.15s;
    }
    .desc-toggle:hover { opacity:0.7; }

    .detail-section-label {
      font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--muted);
      letter-spacing:2px; text-transform:uppercase; margin-bottom:12px;
    }

    .detail-stats-grid {
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:26px;
    }
    .detail-stat {
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:6px; padding:16px 16px;
    }
    .detail-stat-label {
      font-family:'JetBrains Mono',monospace; font-size:0.6rem;
      color:var(--muted); letter-spacing:1px; text-transform:uppercase; margin-bottom:5px;
    }
    .detail-stat-val {
      font-family:'Barlow Condensed',sans-serif; font-size:1.55rem;
      font-weight:700; letter-spacing:0.3px;
    }
    .detail-stat-val.green  { color:var(--green); }
    .detail-stat-val.blue   { color:#6aaeff; }
    .detail-stat-val.teal   { color:var(--accent2); }
    .detail-stat-val.white  { color:var(--text); }
    .detail-stat-val.red    { color:#ff6b6b; }
    .detail-stat-val.muted  { color:var(--muted); }

    .detail-info-grid {
      display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:26px;
    }
    .detail-info-item {
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:6px; padding:13px 16px;
    }
    .detail-info-label {
      font-family:'JetBrains Mono',monospace; font-size:0.6rem;
      color:var(--muted); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px;
    }
    .detail-info-val {
      font-family:'Barlow Condensed',sans-serif; font-size:1.1rem;
      font-weight:700; color:var(--text);
    }

    .detail-chart-wrap {
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:8px; padding:20px 18px 16px;
      margin-bottom:20px;
    }
    .chart-header {
      display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;
    }
    .chart-title {
      font-family:'Barlow Condensed',sans-serif; font-size:1.1rem;
      font-weight:700; color:var(--text);
    }
    .chart-pts {
      font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--muted);
    }
    .chart-canvas-wrap { position:relative; height:200px; }
    .chart-empty {
      height:200px; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:8px;
    }
    .chart-empty-icon { font-size:2rem; opacity:0.25; }
    .chart-empty-text {
      font-family:'JetBrains Mono',monospace; font-size:0.7rem;
      color:var(--muted); letter-spacing:1px; text-align:center; line-height:1.7;
    }

    .detail-loading {
      flex:1; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:12px;
    }
    .detail-spinner {
      width:32px; height:32px; border:2px solid var(--border);
      border-top-color:var(--accent); border-radius:50%;
      animation:spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .detail-loading-text {
      font-family:'JetBrains Mono',monospace; font-size:0.65rem;
      color:var(--muted); letter-spacing:1px;
    }

    .detail-error {
      flex:1; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:8px; padding:32px;
    }
    .detail-error-icon { font-size:2rem; opacity:0.3; }
    .detail-error-text {
      font-family:'JetBrains Mono',monospace; font-size:0.68rem;
      color:#ff6b6b; text-align:center; line-height:1.6;
    }

    /* â”€â”€ HERO â”€â”€ */
    .hero { position:relative; z-index:1; padding:72px 48px 36px; max-width:1500px; margin:0 auto; }
    .hero-eyebrow { font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--accent); letter-spacing:3px; text-transform:uppercase; margin-bottom:14px; opacity:0; animation:up 0.5s ease 0.05s both; }
    .hero h1 { font-family:'Bebas Neue',sans-serif; font-size:clamp(3.8rem,8.5vw,7.5rem); line-height:0.9; letter-spacing:3px; margin-bottom:22px; opacity:0; animation:up 0.5s ease 0.1s both; }
    .hero h1 .bright { color:var(--accent); }
    .hero-sub { color:var(--muted); font-size:1rem; font-weight:500; max-width:460px; line-height:1.75; opacity:0; animation:up 0.5s ease 0.15s both; }
    @keyframes up { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }

    .stats-bar { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:0 48px 30px; display:flex; gap:2px; opacity:0; animation:up 0.5s ease 0.2s both; }
    .stat-pill { background:var(--surface); border:1px solid var(--border); padding:14px 26px; }
    .stat-pill:first-child { border-radius:6px 0 0 6px; }
    .stat-pill:last-child  { border-radius:0 6px 6px 0; }
    .stat-pill-label { font-family:'JetBrains Mono',monospace; font-size:0.62rem; color:var(--muted); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:3px; }
    .stat-pill-val   { font-family:'Barlow Condensed',sans-serif; font-size:1.55rem; font-weight:700; color:var(--text); letter-spacing:1px; }

    .toolbar { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:0 48px 24px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; opacity:0; animation:up 0.5s ease 0.25s both; }
    .toolbar-label { font-family:'JetBrains Mono',monospace; color:var(--muted); font-size:0.68rem; letter-spacing:1.5px; text-transform:uppercase; margin-right:4px; }
    .sort-btn { background:var(--surface); border:1px solid var(--border); color:var(--muted); font-family:'Barlow',sans-serif; font-size:0.88rem; font-weight:600; letter-spacing:0.3px; padding:9px 20px; border-radius:4px; cursor:pointer; transition:all 0.15s; }
    .sort-btn:hover { border-color:rgba(79,142,247,0.45); color:var(--text); }
    .sort-btn.active { background:rgba(79,142,247,0.15); border-color:var(--accent); color:var(--accent); }
    .result-count { margin-left:auto; font-family:'JetBrains Mono',monospace; font-size:0.7rem; color:var(--muted); letter-spacing:1px; }

    .grid-wrap { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:0 48px 32px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:1px; background:var(--border); border:1px solid var(--border); border-radius:8px; overflow:hidden; }

    .card { background:var(--card-bg); cursor:pointer; position:relative; transition:background 0.15s; }
    .card:hover { background:#0f1220; }

    .card-rank { position:absolute; top:10px; left:10px; z-index:2; font-family:'Bebas Neue',sans-serif; font-size:1.15rem; letter-spacing:1px; padding:3px 10px; border-radius:3px; background:rgba(7,8,15,0.75); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,0.12); color:var(--text); line-height:1.4; }

    .card-thumb-wrap { position:relative; overflow:hidden; background:var(--surface); }
    .card-thumb { width:100%; aspect-ratio:1/1; object-fit:cover; display:block; transition:transform 0.35s ease; }
    .card:hover .card-thumb { transform:scale(1.06); }
    .card-thumb-placeholder { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--muted); letter-spacing:2px; }

    .card-body { padding:14px 16px 16px; }
    .card-name { font-family:'Barlow Condensed',sans-serif; font-size:1.15rem; font-weight:700; letter-spacing:0.3px; line-height:1.25; margin-bottom:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .card-stats { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .stat { background:rgba(255,255,255,0.025); border:1px solid rgba(255,255,255,0.045); border-radius:4px; padding:9px 11px; }
    .stat-label { font-family:'JetBrains Mono',monospace; font-size:0.58rem; color:var(--muted); letter-spacing:1px; text-transform:uppercase; margin-bottom:2px; }
    .stat-val { font-family:'Barlow Condensed',sans-serif; font-size:1.05rem; font-weight:700; letter-spacing:0.3px; }
    .stat-val.green   { color:var(--green); }
    .stat-val.blue    { color:#6aaeff; }
    .stat-val.white   { color:var(--text); }
    .stat-val.teal    { color:var(--accent2); }
    .stat-val.muted   { color:var(--muted); font-size:0.88rem; }
    .stat-val.pending { color:var(--muted); font-size:0.88rem; animation:pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:0.4} 50%{opacity:1} }

    .pagination { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:0 48px 80px; display:flex; align-items:center; justify-content:center; gap:5px; flex-wrap:wrap; }
    .page-btn { min-width:44px; height:44px; padding:0 12px; background:var(--surface); border:1px solid var(--border); color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:0.8rem; border-radius:4px; cursor:pointer; transition:all 0.12s; display:flex; align-items:center; justify-content:center; }
    .page-btn:hover:not(:disabled) { border-color:rgba(79,142,247,0.5); color:var(--text); }
    .page-btn.active { background:rgba(79,142,247,0.18); border-color:var(--accent); color:var(--accent); font-weight:700; }
    .page-btn:disabled { opacity:0.25; cursor:not-allowed; }
    .page-ellipsis { min-width:44px; height:44px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:0.8rem; user-select:none; }

    .skeleton { background:var(--card-bg); }
    .skel-thumb { width:100%; aspect-ratio:1/1; background:var(--surface); }
    .skel-body  { padding:14px 16px 16px; }
    .skel-line  { height:8px; border-radius:2px; margin-bottom:8px; background:linear-gradient(90deg,var(--border) 25%,#1e2640 50%,var(--border) 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .no-results { grid-column:1/-1; text-align:center; padding:80px 20px; color:var(--muted); }
    .no-results h3 { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:2px; color:var(--text); margin-bottom:8px; }
    .error-box { grid-column:1/-1; text-align:center; padding:80px 20px; color:var(--muted); }
    .error-box h2 { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:2px; color:var(--text); margin-bottom:8px; }
    .error-box pre { margin:12px auto 0; font-family:'JetBrains Mono',monospace; font-size:0.78rem; background:var(--surface); border:1px solid var(--border); padding:14px; border-radius:4px; max-width:500px; overflow-x:auto; white-space:pre-wrap; }

    footer { position:relative; z-index:1; border-top:1px solid var(--border); padding:20px 48px; text-align:center; color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:1px; }

    ::-webkit-scrollbar { width:5px; }
    ::-webkit-scrollbar-track { background:var(--bg); }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

    @media(max-width:640px) {
      header { padding:0 16px; flex-wrap:wrap; height:auto; gap:10px; padding-top:10px; padding-bottom:10px; }
      .header-center { max-width:100%; margin:0; order:3; width:100%; }
      .hero,.stats-bar,.toolbar,.grid-wrap,.pagination { padding-left:16px; padding-right:16px; }
      .hero h1 { font-size:3.2rem; }
      .grid { grid-template-columns:repeat(2,1fr); }
      .page-btn { min-width:38px; height:38px; font-size:0.72rem; }
      .detail-panel { width:100vw; }
      .detail-stats-grid { grid-template-columns:repeat(2,1fr); }
    }
  </style>
</head>
<body>

<div class="glow"></div>

<header>
  <div class="logo">Roblox<em>Charts</em></div>
  <div class="header-center">
    <div class="search-wrap">
      <div class="search-input-wrap">
        <span class="search-icon">âŒ•</span>
        <input type="text" id="searchInput" placeholder="Search games by nameâ€¦" autocomplete="off" spellcheck="false"/>
        <button class="search-clear" id="searchClear" title="Clear">âœ•</button>
      </div>
      <button id="lookupBtn">Place ID</button>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div>Live</div>
    <button class="refresh-btn" id="refreshBtn">â†» Refresh</button>
  </div>
</header>

<!-- Lookup modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <button class="modal-close" id="modalClose">âœ•</button>
    <div class="modal-title">Place ID Lookup</div>
    <div class="modal-sub">Find any Roblox game â€” even if it's not in the charts</div>
    <div class="modal-input-row">
      <input type="text" id="placeIdInput" placeholder="Enter Place ID or paste Roblox URLâ€¦" autocomplete="off"/>
      <button id="placeIdSubmit">Look Up</button>
    </div>
    <div class="modal-hint">
      Find the ID in the URL: roblox.com/games/<code>82355918293519</code>/game-name<br/>
      Or just paste the full URL and it'll extract the ID automatically.
    </div>
    <div class="lookup-loading" id="lookupLoading">Fetching game dataâ€¦</div>
    <div class="lookup-error"  id="lookupError"></div>
    <div class="lookup-result" id="lookupResult">
      <div class="lookup-result-inner">
        <div id="lookupThumbWrap"></div>
        <div class="lookup-info">
          <div class="lookup-name" id="lookupName"></div>
          <div class="lookup-stats">
            <div class="lookup-stat">Playing<span id="lsPlaying">â€”</span></div>
            <div class="lookup-stat">Visits<span id="lsVisits">â€”</span></div>
            <div class="lookup-stat">Favorites<span id="lsFavs">â€”</span></div>
            <div class="lookup-stat">Likes<span id="lsLikes">â€”</span></div>
            <div class="lookup-stat">Dislikes<span id="lsDislikes">â€”</span></div>
            <div class="lookup-stat">Like Ratio<span id="lsRatio">â€”</span></div>
          </div>
        </div>
      </div>
      <button class="lookup-open-btn" id="lookupOpenBtn">Open on Roblox â†’</button>
    </div>
  </div>
</div>

<!-- Detail panel -->
<div class="detail-backdrop" id="detailBackdrop"></div>
<div class="detail-panel" id="detailPanel">
  <div id="detailContent"></div>
</div>

<section class="hero">
  <div class="hero-eyebrow">Real-time leaderboard</div>
  <h1>TOP ROBLOX GAMES <span class="bright">RIGHT NOW</span></h1>
  <p class="hero-sub">Live player counts, total visits, and favorites â€” pulled from Roblox</p>
</section>

<div class="stats-bar">
  <div class="stat-pill"><div class="stat-pill-label">Total Playing</div><div class="stat-pill-val" id="totalPlaying">â€”</div></div>
  <div class="stat-pill"><div class="stat-pill-label">Games Tracked</div><div class="stat-pill-val" id="gamesTracked">â€”</div></div>
  <div class="stat-pill"><div class="stat-pill-label">Last Updated</div><div class="stat-pill-val" id="lastUpdated">â€”</div></div>
</div>

<div class="toolbar">
  <span class="toolbar-label">Sort by</span>
  <button class="sort-btn active" data-sort="TopCharts">Top Charts</button>
  <button class="sort-btn" data-sort="MostEngaging">Most Engaging</button>
  <button class="sort-btn" data-sort="UpAndComing">Up &amp; Coming</button>
  <span class="result-count" id="resultCount"></span>
</div>

<div class="grid-wrap">
  <div class="grid" id="gameGrid"></div>
</div>

<div class="pagination" id="pagination"></div>

<footer>RobloxCharts â€” not affiliated with Roblox Corporation Â· Data via Rolimons &amp; Roblox public API</footer>

<script>
  const WORKER_URL = 'https://young-resonance-128e.frostyknight2354.workers.dev';
  const PAGE_SIZE  = 100;

  let currentSort  = 'TopCharts';
  let loading      = false;
  let allGames     = [];
  let visibleGames = [];
  let currentPage  = 1;
  let detailCache  = {};
  let pageAbort    = null;
  let activeChart  = null;

  const fmt = n => {
    if (n == null || isNaN(Number(n))) return null;
    n = Number(n);
    if (n >= 1e9) return (n/1e9).toFixed(1)+'B';
    if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
    if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
    return n.toLocaleString();
  };
  const fmtStat = n => fmt(n) ?? 'â€”';

  const fmtDate = iso => {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    return d.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
  };

  function animateCount(el, target) {
    if (!target) { el.textContent = fmtStat(target); return; }
    const dur = 650, t0 = performance.now();
    const tick = now => {
      const p = Math.min((now-t0)/dur, 1);
      el.textContent = fmtStat(Math.round((1-Math.pow(1-p,3))*target));
      if (p < 1) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  async function workerFetch(params, signal) {
    const res = await fetch(WORKER_URL+'?'+new URLSearchParams(params), { signal });
    let data;
    try { data = await res.json(); } catch { throw new Error(`Worker ${res.status}`); }
    if (data.error) throw new Error(data.error);
    return data;
  }

  const escHtml = s => (s||'').replace(/[<>"'&]/g, c =>
    ({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'}[c])
  );

  function extractPlaceId(input) {
    input = input.trim();
    if (/^\d+$/.test(input)) return Number(input);
    const m = input.match(/roblox\.com\/games\/(\d+)/i);
    if (m) return Number(m[1]);
    return null;
  }

  /* â”€â”€ DETAIL PANEL â”€â”€ */
  const detailPanel    = document.getElementById('detailPanel');
  const detailBackdrop = document.getElementById('detailBackdrop');
  const detailContent  = document.getElementById('detailContent');

  function openDetailPanel() {
    detailPanel.classList.add('open');
    detailBackdrop.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeDetailPanel() {
    detailPanel.classList.remove('open');
    detailBackdrop.classList.remove('open');
    document.body.style.overflow = '';
    if (activeChart) { activeChart.destroy(); activeChart = null; }
  }

  detailBackdrop.addEventListener('click', closeDetailPanel);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeDetailPanel(); closeModal(); } });

  function showDetailLoading() {
    if (activeChart) { activeChart.destroy(); activeChart = null; }
    detailContent.innerHTML = `
      <div class="detail-loading">
        <div class="detail-spinner"></div>
        <div class="detail-loading-text">Loading game dataâ€¦</div>
      </div>`;
    detailContent.style.display = 'flex';
    detailContent.style.height  = '100%';
  }

  function showDetailError(msg) {
    detailContent.innerHTML = `
      <div class="detail-error">
        <div class="detail-error-icon">âš </div>
        <div class="detail-error-text">${escHtml(msg)}</div>
      </div>`;
    detailContent.style.display = 'flex';
    detailContent.style.height  = '100%';
  }

  function renderChart(history) {
    const wrap = document.getElementById('detailChartWrap');
    if (!wrap) return;

    if (!history || history.length < 2) {
      wrap.innerHTML = `
        <div class="chart-header">
          <span class="chart-title">Player Count History</span>
          <span class="chart-pts">0 data points</span>
        </div>
        <div class="chart-empty">
          <div class="chart-empty-icon">ðŸ“ˆ</div>
          <div class="chart-empty-text">History is being recorded.<br/>Check back after a few visits to see the chart.</div>
        </div>`;
      return;
    }

    const pts = history.slice(-168);

    const labels = pts.map(p => {
      const d   = new Date(p.t * 1000);
      const now = Date.now();
      const age = now - p.t * 1000;
      if (age < 86400000) {
        return d.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false });
      }
      return d.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + ' ' +
             d.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false });
    });
    const values = pts.map(p => p.p);

    wrap.innerHTML = `
      <div class="chart-header">
        <span class="chart-title">Player Count History</span>
        <span class="chart-pts">${pts.length} data point${pts.length !== 1 ? 's' : ''}</span>
      </div>
      <div class="chart-canvas-wrap"><canvas id="playerChart"></canvas></div>`;

    const ctx = document.getElementById('playerChart').getContext('2d');
    if (activeChart) activeChart.destroy();

    activeChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: values,
          borderColor: '#3a7ff7',
          backgroundColor: ctx => {
            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 160);
            gradient.addColorStop(0, 'rgba(58,127,247,0.25)');
            gradient.addColorStop(1, 'rgba(58,127,247,0)');
            return gradient;
          },
          borderWidth: 2,
          pointRadius: pts.length > 40 ? 0 : 3,
          pointHoverRadius: 5,
          pointBackgroundColor: '#3a7ff7',
          fill: true,
          tension: 0.4,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#0c0e18',
            borderColor: '#181d2e',
            borderWidth: 1,
            titleColor: '#6d748d',
            bodyColor: '#edf0ff',
            titleFont: { family: 'JetBrains Mono', size: 10 },
            bodyFont:  { family: 'Barlow Condensed', size: 14, weight: 'bold' },
            callbacks: {
              label: ctx => ' ' + fmtStat(ctx.raw) + ' playing',
            },
          },
        },
        scales: {
          x: {
            ticks: {
              color: '#6d748d',
              font: { family: 'JetBrains Mono', size: 9 },
              maxTicksLimit: 6,
              maxRotation: 0,
            },
            grid: { color: 'rgba(255,255,255,0.03)' },
            border: { color: '#181d2e' },
          },
          y: {
            ticks: {
              color: '#6d748d',
              font: { family: 'JetBrains Mono', size: 9 },
              callback: v => fmtStat(v),
            },
            grid: { color: 'rgba(255,255,255,0.03)' },
            border: { color: '#181d2e' },
          },
        },
      },
    });
  }

  function renderDetailPanel(g, history) {
    detailContent.style.display = '';
    detailContent.style.height  = '';

    const likeRatio   = g.likeRatio != null ? g.likeRatio + '%' : 'â€”';
    const creatorUrl  = g.creatorType === 'Group'
      ? `https://www.roblox.com/groups/${g.creatorId}`
      : `https://www.roblox.com/users/${g.creatorId}/profile`;
    const hasDesc     = g.description && g.description.trim().length > 0;

    detailContent.innerHTML = `
      <div class="detail-header">
        ${g.iconUrl
          ? `<img class="detail-banner" src="${escHtml(g.iconUrl)}" alt=""/>`
          : `<div class="detail-banner-placeholder"></div>`}
        <div class="detail-header-overlay"></div>
        <button class="detail-close" id="detailCloseBtn">âœ•</button>
        <div class="detail-identity">
          ${g.iconUrl
            ? `<img class="detail-thumb-sm" src="${escHtml(g.iconUrl)}" alt="${escHtml(g.name)}"/>`
            : `<div class="detail-thumb-sm-placeholder">NO IMG</div>`}
          <div class="detail-title-block">
            <div class="detail-game-name" title="${escHtml(g.name)}">${escHtml(g.name)}</div>
            <div class="detail-creator">by <a href="${escHtml(creatorUrl)}" target="_blank" rel="noopener">${escHtml(g.creator)}</a> Â· ${escHtml(g.creatorType)}</div>
          </div>
        </div>
      </div>

      <div class="detail-body">
        <div class="detail-meta-row">
          ${g.genre && g.genre !== 'All' ? `<span class="detail-badge genre">${escHtml(g.genre)}</span>` : ''}
          <span class="detail-badge roblox" id="detailOpenRoblox">Open on Roblox â†—</span>
        </div>

        ${hasDesc ? `<div class="detail-description" id="detailDesc">${escHtml(g.description)}</div>
        <button class="desc-toggle" id="descToggle">Show more</button>` : ''}

        <div class="detail-section-label">Live Stats</div>
        <div class="detail-stats-grid">
          <div class="detail-stat">
            <div class="detail-stat-label">Playing Now</div>
            <div class="detail-stat-val green">${fmtStat(g.playerCount)}</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-label">Total Visits</div>
            <div class="detail-stat-val blue">${fmtStat(g.visits)}</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-label">Favorites</div>
            <div class="detail-stat-val teal">${fmtStat(g.favorites)}</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-label">Upvotes</div>
            <div class="detail-stat-val green">${fmtStat(g.likes)}</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-label">Downvotes</div>
            <div class="detail-stat-val red">${fmtStat(g.dislikes)}</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-label">Like Ratio</div>
            <div class="detail-stat-val white">${likeRatio}</div>
          </div>
        </div>

        <div class="detail-section-label">Game Info</div>
        <div class="detail-info-grid">
          <div class="detail-info-item">
            <div class="detail-info-label">Created</div>
            <div class="detail-info-val">${fmtDate(g.created)}</div>
          </div>
          <div class="detail-info-item">
            <div class="detail-info-label">Last Updated</div>
            <div class="detail-info-val">${fmtDate(g.updated)}</div>
          </div>
          <div class="detail-info-item">
            <div class="detail-info-label">Max Players</div>
            <div class="detail-info-val">${g.maxPlayers ?? 'â€”'}</div>
          </div>
          <div class="detail-info-item">
            <div class="detail-info-label">Place ID</div>
            <div class="detail-info-val">${g.placeId}</div>
          </div>
        </div>

        <div class="detail-chart-wrap" id="detailChartWrap"></div>
      </div>`;

    document.getElementById('detailCloseBtn').addEventListener('click', closeDetailPanel);
    document.getElementById('detailOpenRoblox').addEventListener('click', () => {
      window.open(`https://www.roblox.com/games/${g.placeId}`, '_blank');
    });

    if (hasDesc) {
      const descEl   = document.getElementById('detailDesc');
      const toggleEl = document.getElementById('descToggle');
      const needsToggle = g.description.length > 200;
      if (!needsToggle) { toggleEl.style.display = 'none'; }
      else {
        toggleEl.addEventListener('click', () => {
          const expanded = descEl.classList.toggle('expanded');
          toggleEl.textContent = expanded ? 'Show less' : 'Show more';
        });
      }
    }

    renderChart(history);
  }

  async function openGameDetail(placeId) {
    openDetailPanel();
    showDetailLoading();
    try {
      const data = await workerFetch({ action: 'get-game-detail', placeId });
      renderDetailPanel(data.game, data.history);
    } catch(err) {
      showDetailError(err.message);
    }
  }

  /* â”€â”€ LOOKUP MODAL â”€â”€ */
  const modalOverlay = document.getElementById('modalOverlay');

  function openModal() { modalOverlay.classList.add('open'); document.getElementById('placeIdInput').focus(); }
  function closeModal() { modalOverlay.classList.remove('open'); resetLookup(); }
  function resetLookup() {
    document.getElementById('lookupResult').classList.remove('visible');
    document.getElementById('lookupError').classList.remove('visible');
    document.getElementById('lookupLoading').classList.remove('visible');
    document.getElementById('placeIdInput').value = '';
    document.getElementById('placeIdSubmit').disabled = false;
  }

  async function doLookup() {
    const placeId = extractPlaceId(document.getElementById('placeIdInput').value);
    const errEl   = document.getElementById('lookupError');
    const loadEl  = document.getElementById('lookupLoading');
    const resEl   = document.getElementById('lookupResult');

    errEl.classList.remove('visible');
    resEl.classList.remove('visible');

    if (!placeId) {
      errEl.textContent = 'Invalid input â€” enter a Place ID number or paste a Roblox URL.';
      errEl.classList.add('visible');
      return;
    }

    loadEl.classList.add('visible');
    document.getElementById('placeIdSubmit').disabled = true;

    try {
      const data = await workerFetch({ action: 'lookup-place', placeId });
      const g = data.game;

      const thumbWrap = document.getElementById('lookupThumbWrap');
      thumbWrap.innerHTML = g.iconUrl
        ? `<img class="lookup-thumb" src="${escHtml(g.iconUrl)}" alt="${escHtml(g.name)}"/>`
        : `<div class="lookup-thumb-placeholder">NO IMG</div>`;

      document.getElementById('lookupName').textContent     = g.name;
      document.getElementById('lsPlaying').textContent      = fmtStat(g.playerCount);
      document.getElementById('lsVisits').textContent       = fmtStat(g.visits);
      document.getElementById('lsFavs').textContent         = fmtStat(g.favorites);
      document.getElementById('lsLikes').textContent        = fmtStat(g.likes);
      document.getElementById('lsDislikes').textContent     = fmtStat(g.dislikes);
      document.getElementById('lsRatio').textContent        = g.likeRatio != null ? g.likeRatio + '%' : 'N/A';
      document.getElementById('lookupOpenBtn').onclick      = () => {
        closeModal();
        openGameDetail(g.placeId);
      };

      resEl.classList.add('visible');
    } catch(err) {
      errEl.textContent = err.message;
      errEl.classList.add('visible');
    } finally {
      loadEl.classList.remove('visible');
      document.getElementById('placeIdSubmit').disabled = false;
    }
  }

  document.getElementById('lookupBtn').addEventListener('click', openModal);
  document.getElementById('modalClose').addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
  document.getElementById('placeIdSubmit').addEventListener('click', doLookup);
  document.getElementById('placeIdInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLookup();
  });

  /* â”€â”€ CARD / GRID â”€â”€ */
  function buildCard(g, rank) {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.placeid = g.placeId;

    const name   = escHtml(g.name || 'Unknown');
    const detail = detailCache[g.placeId];
    const loaded = detail !== undefined && detail !== null;

    const sv = (field, cls, suffix='') => {
      if (!loaded) return `<div class="stat-val pending" data-field="${field}">â€¦</div>`;
      const val = detail[field];
      if (val == null) return `<div class="stat-val muted" data-field="${field}">â€”</div>`;
      return `<div class="stat-val ${cls}" data-field="${field}">${suffix ? val + suffix : fmtStat(val)}</div>`;
    };

    card.innerHTML = `
      <div class="card-thumb-wrap">
        ${g.iconUrl
          ? `<img class="card-thumb" src="${g.iconUrl}" alt="${name}" loading="lazy" decoding="async"/>`
          : `<div class="card-thumb-placeholder">NO IMG</div>`}
        <div class="card-rank">#${rank}</div>
      </div>
      <div class="card-body">
        <div class="card-name" title="${name}">${name}</div>
        <div class="card-stats">
          <div class="stat"><div class="stat-label">Playing</div><div class="stat-val green">${fmtStat(g.playerCount)}</div></div>
          <div class="stat"><div class="stat-label">Visits</div>${sv('visits','blue')}</div>
          <div class="stat"><div class="stat-label">Favorites</div>${sv('favorites','teal')}</div>
          <div class="stat"><div class="stat-label">Like Ratio</div>${sv('likeRatio','white','%')}</div>
        </div>
      </div>`;

    card.addEventListener('click', () => openGameDetail(g.placeId));
    return card;
  }

  function patchCardDetails(details) {
    Object.entries(details).forEach(([placeId, d]) => {
      if (!d) return;
      detailCache[placeId] = d;
      const card = document.querySelector(`.card[data-placeid="${placeId}"]`);
      if (!card) return;
      [['visits','blue'],['favorites','teal'],['likeRatio','white']].forEach(([field, cls]) => {
        const el = card.querySelector(`[data-field="${field}"]`);
        if (!el) return;
        const val = d[field];
        if (val == null) {
          el.textContent = 'â€”';
          el.className   = 'stat-val muted';
        } else {
          el.textContent = field === 'likeRatio' ? val + '%' : fmtStat(val);
          el.className   = `stat-val ${cls}`;
        }
      });
    });
  }

  async function fetchDetailsForPage(games, signal) {
    const ids = games.map(g => g.placeId).filter(id => id && !detailCache[id]);
    if (!ids.length) return;
    for (let i = 0; i < ids.length; i += 25) {
      if (signal?.aborted) return;
      const batch = ids.slice(i, i + 25);
      try {
        const data = await workerFetch({ action: 'get-details', placeIds: batch.join(',') }, signal);
        if (data.details) patchCardDetails(data.details);
      } catch(err) {
        if (err.name === 'AbortError') return;
        console.warn('Detail batch failed:', err.message);
      }
    }
  }

  function totalPages() { return Math.ceil(visibleGames.length / PAGE_SIZE); }

  function renderPagination() {
    const pag = document.getElementById('pagination');
    const tp  = totalPages();
    pag.innerHTML = '';
    if (tp <= 1) return;

    const cp = currentPage;

    const mkBtn = (label, page) => {
      const b = document.createElement('button');
      b.className = 'page-btn';
      b.textContent = label;
      if (page === cp) b.classList.add('active');
      if (page === null) b.disabled = true;
      else b.addEventListener('click', () => goToPage(page));
      return b;
    };

    const ellipsis = () => {
      const s = document.createElement('span');
      s.className = 'page-ellipsis';
      s.textContent = 'â€¦';
      return s;
    };

    const prev = document.createElement('button');
    prev.className = 'page-btn';
    prev.textContent = 'â†';
    prev.disabled = cp === 1;
    if (cp > 1) prev.addEventListener('click', () => goToPage(cp-1));
    pag.appendChild(prev);

    const show = new Set([1, tp]);
    for (let d = -2; d <= 2; d++) { const p = cp+d; if (p >= 1 && p <= tp) show.add(p); }
    const pages = [...show].sort((a,b) => a-b);
    let prev_p = 0;
    pages.forEach(p => {
      if (p - prev_p > 1) pag.appendChild(ellipsis());
      pag.appendChild(mkBtn(p, p));
      prev_p = p;
    });

    const next = document.createElement('button');
    next.className = 'page-btn';
    next.textContent = 'â†’';
    next.disabled = cp === tp;
    if (cp < tp) next.addEventListener('click', () => goToPage(cp+1));
    pag.appendChild(next);
  }

  function goToPage(page) {
    if (page === currentPage) return;
    if (pageAbort) pageAbort.abort();
    currentPage = page;
    renderPage();
    document.querySelector('.grid-wrap').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  function renderPage() {
    const grid  = document.getElementById('gameGrid');
    const start = (currentPage-1)*PAGE_SIZE;
    const slice = visibleGames.slice(start, start+PAGE_SIZE);

    if (!slice.length) {
      grid.innerHTML = `<div class="no-results"><h3>No Results</h3><p>Try a different search term.</p></div>`;
      document.getElementById('pagination').innerHTML = '';
      return;
    }

    const frag = document.createDocumentFragment();
    slice.forEach((g,i) => frag.appendChild(buildCard(g, start+i+1)));
    grid.innerHTML = '';
    grid.appendChild(frag);
    renderPagination();

    pageAbort = new AbortController();
    fetchDetailsForPage(slice, pageAbort.signal);
  }

  function setVisibleGames(games) {
    visibleGames = games;
    currentPage  = 1;

    if (!games.length) {
      document.getElementById('gameGrid').innerHTML =
        `<div class="no-results"><h3>No Results</h3><p>Try a different search term.</p></div>`;
      document.getElementById('pagination').innerHTML = '';
      document.getElementById('resultCount').textContent = '';
      return;
    }

    const total = games.reduce((s,g) => s+(g.playerCount||0), 0);
    animateCount(document.getElementById('totalPlaying'), total);
    document.getElementById('gamesTracked').textContent = allGames.length.toLocaleString();
    document.getElementById('lastUpdated').textContent  = new Date().toLocaleTimeString();

    const q  = document.getElementById('searchInput').value.trim();
    const tp = totalPages();
    document.getElementById('resultCount').textContent = q
      ? `${games.length.toLocaleString()} result${games.length!==1?'s':''}`
      : `${games.length.toLocaleString()} games Â· ${tp} page${tp!==1?'s':''}`;

    renderPage();
  }

  function showSkeletons() {
    const grid = document.getElementById('gameGrid');
    const frag = document.createDocumentFragment();
    for (let i = 0; i < 40; i++) {
      const el = document.createElement('div');
      el.className = 'skeleton';
      el.innerHTML = `<div class="skel-thumb"></div><div class="skel-body">
        <div class="skel-line" style="width:60%"></div>
        <div class="skel-line" style="width:40%"></div>
        <div class="skel-line" style="width:50%"></div></div>`;
      frag.appendChild(el);
    }
    grid.innerHTML = '';
    grid.appendChild(frag);
    document.getElementById('pagination').innerHTML = '';
  }

  function applySearch() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    document.getElementById('searchClear').classList.toggle('visible', q.length > 0);
    if (!allGames.length) return;
    if (pageAbort) pageAbort.abort();
    setVisibleGames(q ? allGames.filter(g => (g.name||'').toLowerCase().includes(q)) : allGames);
  }

  async function load(sortName) {
    if (loading) return;
    loading = true;

    if (pageAbort) pageAbort.abort();
    detailCache = {};

    document.getElementById('refreshBtn').disabled = true;
    document.querySelectorAll('.sort-btn').forEach(b => b.disabled = true);
    showSkeletons();

    try {
      const data = await workerFetch({ action: 'get-sort-content', sortId: sortName });
      allGames = data.games || [];
      if (!allGames.length) throw new Error('No games returned from data source');

      document.getElementById('searchInput').value = '';
      document.getElementById('searchClear').classList.remove('visible');

      setVisibleGames(allGames);
    } catch(err) {
      if (err.name === 'AbortError') return;
      console.error(err);
      document.getElementById('gameGrid').innerHTML = `
        <div class="error-box">
          <h2>Couldn't Load Games</h2>
          <p>Something went wrong fetching data.</p>
          <pre>${escHtml(err.message)}</pre>
        </div>`;
    } finally {
      loading = false;
      document.getElementById('refreshBtn').disabled = false;
      document.querySelectorAll('.sort-btn').forEach(b => b.disabled = false);
    }
  }

  document.querySelectorAll('.sort-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.classList.contains('active') || loading) return;
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentSort = btn.dataset.sort;
      load(currentSort);
    });
  });

  document.getElementById('refreshBtn').addEventListener('click', () => {
    if (!loading) load(currentSort);
  });

  let searchTimer;
  document.getElementById('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(applySearch, 150);
  });

  document.getElementById('searchClear').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchClear').classList.remove('visible');
    if (pageAbort) pageAbort.abort();
    setVisibleGames(allGames);
    document.getElementById('searchInput').focus();
  });

  load(currentSort);
</script>
</body>
</html>